<div class="container">
  <header>
    <h1>{{ title() }}</h1>
    <p class="subtitle">Sistema de Logging, Observabilidade e Distributed Tracing</p>
  </header>

  <div class="environment-info">
    <h2>VariÃ¡veis de Ambiente</h2>
    <div class="env-grid">
      <div class="env-item">
        <strong>Ambiente:</strong>
        <span>{{ environment.production ? 'Production' : 'Development' }}</span>
      </div>
      <div class="env-item">
        <strong>API URL:</strong>
        <span>{{ environment.apiUrl }}</span>
      </div>
      <div class="env-item">
        <strong>Backend API:</strong>
        <span>{{ environment.backendApiUrl }}</span>
      </div>
      <div class="env-item">
        <strong>Log Level:</strong>
        <span>{{ environment.logLevel }}</span>
      </div>
      <div class="env-item">
        <strong>OpenTelemetry:</strong>
        <span>{{ environment.otel.enabled ? 'Enabled' : 'Disabled' }}</span>
      </div>
      <div class="env-item">
        <strong>Version:</strong>
        <span>{{ environment.version }}</span>
      </div>
    </div>
  </div>

  <!-- DISTRIBUTED TRACING SECTION -->
  <div class="distributed-tracing-section">
    <h2>ğŸ”— Distributed Tracing Tests</h2>
    <p class="section-description">
      Teste a propagaÃ§Ã£o de traces entre Angular (frontend) e .NET API (backend).
      Visualize no <a href="http://localhost:16686" target="_blank">Jaeger UI</a>.
    </p>

    <div class="api-status" [ngClass]="getStatusClass()">
      <span class="status-indicator"></span>
      <span class="status-text">
        @switch (apiStatus()) {
        @case ('idle') { Aguardando aÃ§Ã£o... }
        @case ('loading') { Carregando... }
        @case ('success') { âœ“ Sucesso! }
        @case ('error') { âœ— Erro! }
        }
      </span>
    </div>

    <div class="button-group tracing-buttons">
      <button (click)="testHealthCheck()" class="btn btn-trace btn-health">
        ğŸ¥ Health Check
      </button>
      <button (click)="testGetUsers()" class="btn btn-trace btn-users">
        ğŸ‘¥ Get Users
      </button>
      <button (click)="testGetUserById()" class="btn btn-trace btn-user">
        ğŸ‘¤ Get User by ID
      </button>
      <button (click)="testCreateOrder()" class="btn btn-trace btn-order">
        ğŸ›’ Create Order
      </button>
      <button (click)="testSlowOperation()" class="btn btn-trace btn-slow">
        â±ï¸ Slow Operation
      </button>
      <button (click)="testExternalCall()" class="btn btn-trace btn-external">
        ğŸŒ External Call
      </button>
    </div>

    <h3 class="error-section-title">âš ï¸ Error Simulation (Trace com Erro)</h3>
    <p class="error-section-description">
      Teste traces com diferentes tipos de erro. Visualize no Jaeger como os erros sÃ£o capturados e propagados.
    </p>

    <div class="button-group error-buttons">
      <button (click)="testBadRequest()" class="btn btn-error-sim btn-400">
        âŒ 400 Bad Request
      </button>
      <button (click)="testNotFound()" class="btn btn-error-sim btn-404">
        ğŸ” 404 Not Found
      </button>
      <button (click)="testInternalError()" class="btn btn-error-sim btn-500">
        ğŸ’¥ 500 Internal Error
      </button>
      <button (click)="testException()" class="btn btn-error-sim btn-exception">
        ğŸ”¥ Unhandled Exception
      </button>
      <button (click)="testDatabaseError()" class="btn btn-error-sim btn-database">
        ğŸ—„ï¸ Database Error
      </button>
      <button (click)="testCascadeError()" class="btn btn-error-sim btn-cascade">
        ğŸ”— Cascade Error
      </button>
    </div>

    <h3 class="observability-section-title">ğŸ§ª Observability Tests (Loki + Jaeger + Prometheus)</h3>
    <p class="observability-section-description">
      Teste a integraÃ§Ã£o completa de logs, traces e mÃ©tricas. Visualize no
      <a href="http://localhost:3000" target="_blank">Grafana</a>,
      <a href="http://localhost:16686" target="_blank">Jaeger</a> e
      <a href="http://localhost:9090" target="_blank">Prometheus</a>.
    </p>

    <div class="button-group observability-buttons">
      <button (click)="testObservabilityLogs()" class="btn btn-observability btn-logs">
        ğŸ“ Test Logs
      </button>
      <button (click)="testNestedTraces()" class="btn btn-observability btn-nested">
        ğŸ” Nested Traces (7 spans)
      </button>
      <button (click)="testLatency('fast')" class="btn btn-observability btn-fast">
        âš¡ Fast (10-50ms)
      </button>
      <button (click)="testLatency('slow')" class="btn btn-observability btn-slow-lat">
        ğŸ¢ Slow (500-1000ms)
      </button>
      <button (click)="testLatency('very-slow')" class="btn btn-observability btn-very-slow">
        ğŸ¦¥ Very Slow (2-5s)
      </button>
      <button (click)="testBatchProcessing()" class="btn btn-observability btn-batch">
        ğŸ“¦ Batch Processing
      </button>
      <button (click)="testMetricsGeneration()" class="btn btn-observability btn-metrics">
        ğŸ“Š Generate Metrics
      </button>
      <button (click)="testCompleteFlow()" class="btn btn-observability btn-complete">
        ğŸš€ Complete Flow
      </button>
    </div>

    @if (lastApiResponse()) {
    <div class="api-response">
      <h4>Last API Response:</h4>
      <pre>{{ lastApiResponse() | json }}</pre>
    </div>
    }

    @if (users().length > 0) {
    <div class="data-display">
      <h4>Users ({{ users().length }}):</h4>
      <div class="data-list">
        @for (user of users(); track user.id) {
        <div class="data-item">
          <span class="data-id">#{{ user.id }}</span>
          <span class="data-name">{{ user.name }}</span>
          <span class="data-role">{{ user.role }}</span>
        </div>
        }
      </div>
    </div>
    }

    @if (orders().length > 0) {
    <div class="data-display">
      <h4>Orders ({{ orders().length }}):</h4>
      <div class="data-list">
        @for (order of orders(); track order.id) {
        <div class="data-item">
          <span class="data-id">#{{ order.id }}</span>
          <span class="data-name">User {{ order.userId }}</span>
          <span class="data-role">${{ order.totalAmount }}</span>
        </div>
        }
      </div>
    </div>
    }
  </div>

  <div class="actions">
    <h2>ğŸ“ Test Logger</h2>
    <div class="button-group">
      <button (click)="testDebugLog()" class="btn btn-debug">Test DEBUG Log</button>
      <button (click)="testInfoLog()" class="btn btn-info">Test INFO Log</button>
      <button (click)="testWarnLog()" class="btn btn-warn">Test WARN Log</button>
      <button (click)="testErrorLog()" class="btn btn-error">Test ERROR Log</button>
    </div>

    <h2>ğŸ” Test Observability</h2>
    <div class="button-group">
      <button (click)="testHttpRequest()" class="btn btn-http">Test HTTP Request</button>
      <button (click)="testErrorHandling()" class="btn btn-error-handler">Test Error Handler</button>
    </div>

    <div class="button-group">
      <button (click)="clearLogs()" class="btn btn-clear">Clear Log History</button>
    </div>
  </div>

  <div class="log-history">
    <h2>Log History ({{ logHistory().length }} entries)</h2>
    <div class="log-container">
      @if (logHistory().length === 0) {
      <p class="no-logs">No logs yet. Click the buttons above to generate logs.</p>
      } @else {
      <div class="log-entries">
        @for (log of logHistory(); track log.timestamp) {
        <div class="log-entry" [ngClass]="getLogLevelClass(log.level)">
          <div class="log-header">
            <span class="log-timestamp">{{ log.timestamp | date:'HH:mm:ss.SSS' }}</span>
            <span class="log-level">{{ getLogLevelName(log.level) }}</span>
            <span class="log-source">{{ log.source }}</span>
          </div>
          <div class="log-message">{{ log.message }}</div>
          @if (log.data) {
          <div class="log-data">
            <pre>{{ log.data | json }}</pre>
          </div>
          }
        </div>
        }
      </div>
      }
    </div>
  </div>

  <div class="instructions">
    <h2>ğŸ“– InstruÃ§Ãµes</h2>
    <ul>
      <li><strong>Distributed Tracing:</strong> Clique nos botÃµes de tracing para testar a propagaÃ§Ã£o de traces entre
        Angular e .NET API</li>
      <li><strong>Jaeger UI:</strong> Acesse <a href="http://localhost:16686" target="_blank">http://localhost:16686</a>
        para visualizar os traces</li>
      <li>Procure pelo service <code>angular-observability-demo</code> ou <code>otel-tracing-api</code></li>
      <li>Verifique se o mesmo <code>trace_id</code> aparece em ambos os serviÃ§os</li>
      <li>Abra o Console do navegador (F12) para ver os logs formatados</li>
    </ul>
  </div>

  <router-outlet />
</div>